---
- name: Set up firewall on Ubuntu 18.04 and CentOS 9
  hosts: all
  become: true

  tasks:
    - name: Install UFW on Ubuntu 18.04
      ansible.builtin.apt:
        name: ufw
        state: present
        update_cache: yes
      when:
        - ansible_facts['os_family'] == 'Debian'
        - ansible_facts['distribution_version'] == '18.04'

    - name: Enable and configure UFW on Ubuntu 18.04
      ansible.builtin.command: "{{ item }}"
      loop:
        - ufw allow OpenSSH
        - ufw enable
      when:
        - ansible_facts['os_family'] == 'Debian'
        - ansible_facts['distribution_version'] == '18.04'

    - name: Install firewalld on CentOS 9
      ansible.builtin.yum:
        name: firewalld
        state: present
      when:
        - ansible_facts['os_family'] == 'RedHat'
        - ansible_facts['distribution_major_version'] == '9'

    - name: Enable and start firewalld on CentOS 9
      ansible.builtin.service:
        name: firewalld
        state: started
        enabled: true
      when:
        - ansible_facts['os_family'] == 'RedHat'
        - ansible_facts['distribution_major_version'] == '9'

    - name: Allow SSH in firewalld (CentOS 9)
      ansible.builtin.firewalld:
        service: ssh
        permanent: true
        state: enabled
        immediate: yes
      when:
        - ansible_facts['os_family'] == 'RedHat'
        - ansible_facts['distribution_major_version'] == '9'
